# å±‚è¾“å‡ºå¯¹æ¯”å·¥å…· - ä½¿ç”¨æ€»ç»“

## âœ… å·²åˆ›å»ºçš„æ–‡ä»¶

### æ ¸å¿ƒè„šæœ¬

1. **save_layer_outputs.py** - ä¿å­˜å±‚è¾“å‡ºçš„ä¸»è„šæœ¬
   - æ”¯æŒFP32/FP16å’Œæ‰€æœ‰é‡åŒ–mode (0, 2-0, 2-1, 2-2, 2-3, 2-4, 3)
   - ä¿å­˜ç¬¬1å±‚å’Œç¬¬24å±‚ï¼ˆæœ€åä¸€å±‚ï¼‰è¾“å‡ºåˆ°numpyæ–‡ä»¶
   - è®¡ç®—å¹¶ä¿å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆmean, std, min, maxï¼‰

2. **compare_with_fp.py** - å¯¹æ¯”è„šæœ¬
   - å¯¹æ¯”æŒ‡å®šmodeä¸FP32å‚è€ƒçš„è¾“å‡ºå·®å¼‚
   - è®¡ç®—MSE, RMSE, MAE, ç›¸å…³ç³»æ•°ç­‰æŒ‡æ ‡
   - è¾“å‡ºè¯¦ç»†çš„ç»Ÿè®¡åˆ†æå’Œç™¾åˆ†ä½æ•°ä¿¡æ¯

### è¾…åŠ©è„šæœ¬

3. **save_all_modes.sh** - æ‰¹é‡ä¿å­˜è„šæœ¬
   - ä¸€é”®ä¿å­˜æ‰€æœ‰modesæˆ–æŒ‡å®šmodes
   - æ”¯æŒ: `fp_only`, `quant_only`, `essential`, æˆ–è‡ªå®šä¹‰åˆ—è¡¨

4. **compare_all_modes.sh** - æ‰¹é‡å¯¹æ¯”è„šæœ¬
   - å¯¹æ¯”æ‰€æœ‰é‡åŒ–modesä¸FP32å‚è€ƒ
   - ç”Ÿæˆæ±‡æ€»è¡¨æ ¼

5. **comparewithfp** - ç®€åŒ–å‘½ä»¤è¡Œå·¥å…·
   - å¿«é€Ÿå¯¹æ¯”å•ä¸ªmode: `./comparewithfp 2-1`

6. **LAYER_COMPARISON_README.md** - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ä¿å­˜å±‚è¾“å‡º

```bash
# ä¿å­˜FP32å‚è€ƒï¼ˆå¿…é¡»å…ˆè¿è¡Œï¼‰
python3 save_layer_outputs.py quamba-130m-w8a8 \
    --pretrained_dir pretrained_models/Quamba1-pa9999/pa-0.9999 \
    --mode fp32

# ä¿å­˜é‡åŒ–mode
python3 save_layer_outputs.py quamba-130m-w8a8 \
    --pretrained_dir pretrained_models/Quamba1-pa9999/pa-0.9999 \
    --mode 2-1 --quantize
```

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `layer_outputs/mode_fp32_layer_0.npy` - ç¬¬1å±‚è¾“å‡ºï¼ˆnumpyæ•°ç»„ï¼‰
- `layer_outputs/mode_fp32_layer_23.npy` - ç¬¬24å±‚è¾“å‡º
- `layer_outputs/mode_fp32_stats.json` - ç»Ÿè®¡ä¿¡æ¯

### 2. å¯¹æ¯”è¾“å‡ºå·®å¼‚

```bash
# ç®€åŒ–å‘½ä»¤ï¼ˆæ¨èï¼‰
./comparewithfp 2-1

# å®Œæ•´å‘½ä»¤
python3 compare_with_fp.py 2-1 --reference fp32 --output_dir layer_outputs
```

**è¾“å‡ºæŒ‡æ ‡ï¼š**
- **åŸºæœ¬ç»Ÿè®¡**: Mean, Std, Min, Max (FP32å’ŒMode)
- **å·®å¼‚ç»Ÿè®¡**: Mean Diff, Std Diff, Max Abs Diff
- **è¯¯å·®æŒ‡æ ‡**: MSE, RMSE, MAE
- **ç›¸å¯¹æŒ‡æ ‡**: Relative MSE, Relative MAE, Correlation
- **ç™¾åˆ†ä½æ•°**: P50, P90, P95, P99 (ç»å¯¹å·®å€¼)

---

## ğŸ“Š å…¸å‹å·¥ä½œæµç¨‹

### æµç¨‹1ï¼šå¿«é€Ÿå¯¹æ¯”å•ä¸ªmode

```bash
# 1. ä¿å­˜FP32å‚è€ƒï¼ˆåªéœ€è¿è¡Œä¸€æ¬¡ï¼‰
./save_all_modes.sh fp_only

# 2. ä¿å­˜ç›®æ ‡mode
python3 save_layer_outputs.py quamba-130m-w8a8 \
    --pretrained_dir pretrained_models/Quamba1-pa9999/pa-0.9999 \
    --mode 2-1 --quantize

# 3. å¯¹æ¯”
./comparewithfp 2-1
```

### æµç¨‹2ï¼šæ‰¹é‡å¯¹æ¯”æ‰€æœ‰modes

```bash
# 1. ä¿å­˜æ‰€æœ‰modesï¼ˆè€—æ—¶ï¼Œå»ºè®®overnightè¿è¡Œï¼‰
./save_all_modes.sh

# 2. æ‰¹é‡å¯¹æ¯”ç”Ÿæˆæ±‡æ€»
./compare_all_modes.sh
```

### æµç¨‹3ï¼šè‡ªå®šä¹‰å¯¹æ¯”

```bash
# 1. ä¿å­˜å…³é”®modes
./save_all_modes.sh essential  # FP32, 0, 2-1, 2-2, 2-4

# 2. é€ä¸ªå¯¹æ¯”
./comparewithfp 0
./comparewithfp 2-1
./comparewithfp 2-2
./comparewithfp 2-4
```

---

## ğŸ“ˆ è¾“å‡ºç¤ºä¾‹

### å¯¹æ¯”è¾“å‡ºç¤ºä¾‹

```
================================================================================
Layer 0 - Comparison Results
================================================================================

ğŸ“Š FP32 Reference Statistics:
  Mean:       0.000123
  Std:        0.234567
  Range:     [-1.234567,  2.345678]

ğŸ“Š Mode Output Statistics:
  Mean:       0.000120
  Std:        0.234560
  Range:     [-1.234500,  2.345600]

ğŸ“ Difference (Mode - FP32):
  Mean Diff:         0.000003
  Std Diff:          0.000007
  Mean Abs Diff:     0.012345
  Max Abs Diff:      0.123456

âŒ Error Metrics:
  MSE:               1.234567e-04
  RMSE:              0.011111
  MAE:               0.012345

ğŸ“ˆ Relative Metrics:
  Relative MSE:      1.234567e-03 ( 0.123%)
  Relative MAE:      5.678901e-03 ( 0.568%)
  Correlation:       0.999999

================================================================================

SUMMARY - All Layers

================================================================================
Layer      MSE             RMSE        MAE         Correlation
--------------------------------------------------------------------------------
0          1.234567e-04    0.011111    0.012345    0.999999
23         2.345678e-04    0.015321    0.023456    0.999998
================================================================================

Average across all layers:
  MSE:         1.790123e-04
  MAE:         0.017900
  Correlation: 0.999998
```

### æ±‡æ€»è¡¨æ ¼ç¤ºä¾‹

```
================================================================================
SUMMARY TABLE - All Modes vs fp32
================================================================================

Mode       Layer 0 MSE     Layer 0 MAE  Last Layer MSE  Last Layer MAE  Avg Corr
----------------------------------------------------------------------------------------------------
0          1.234567e-04    0.012345     2.345678e-04    0.023456        0.999999
2-0        1.234568e-04    0.012346     2.345679e-04    0.023457        0.999998
2-1        2.345678e-04    0.023456     3.456789e-04    0.034567        0.999997
2-2        3.456789e-04    0.034567     4.567890e-04    0.045678        0.999996
2-3        1.234567e-04    0.012345     2.345678e-04    0.023456        0.999999
2-4        1.234568e-04    0.012346     2.345679e-04    0.023457        0.999998
3          2.345678e-04    0.023456     3.456789e-04    0.034567        0.999997
================================================================================
```

---

## ğŸ“ è§£è¯»æŒ‡æ ‡

### MSE (Mean Squared Error) - å‡æ–¹è¯¯å·®

| MSEèŒƒå›´ | è¯„ä»· | è¯´æ˜ |
|---------|------|------|
| < 1e-5 | ä¼˜ç§€ | ä¸FP32å‡ ä¹æ— å·®å¼‚ |
| 1e-5 ~ 1e-4 | å¾ˆå¥½ | å·®å¼‚å¾ˆå°ï¼Œå¯æ¥å— |
| 1e-4 ~ 1e-3 | è‰¯å¥½ | æœ‰ä¸€å®šå·®å¼‚ï¼Œé€šå¸¸å¯æ¥å— |
| 1e-3 ~ 1e-2 | ä¸€èˆ¬ | å·®å¼‚æ˜æ˜¾ï¼Œéœ€è¦å…³æ³¨ |
| > 1e-2 | è¾ƒå·® | å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦ä¼˜åŒ– |

### Correlation - ç›¸å…³ç³»æ•°

| Correlation | è¯„ä»· | è¯´æ˜ |
|-------------|------|------|
| > 0.9999 | å®Œç¾ | è¾“å‡ºæ¨¡å¼å‡ ä¹ä¸€è‡´ |
| 0.999 ~ 0.9999 | ä¼˜ç§€ | é«˜åº¦ç›¸å…³ |
| 0.99 ~ 0.999 | è‰¯å¥½ | ç›¸å…³æ€§å¾ˆå¥½ |
| 0.95 ~ 0.99 | ä¸€èˆ¬ | æœ‰ä¸€å®šç›¸å…³æ€§ |
| < 0.95 | è¾ƒå·® | ç›¸å…³æ€§è¾ƒå¼± |

### Relative MAE - ç›¸å¯¹å¹³å‡ç»å¯¹è¯¯å·®

| Relative MAE | è¯„ä»· | è¯´æ˜ |
|--------------|------|------|
| < 0.1% | ä¼˜ç§€ | ç›¸å¯¹è¯¯å·®æå° |
| 0.1% ~ 1% | å¾ˆå¥½ | ç›¸å¯¹è¯¯å·®å¾ˆå° |
| 1% ~ 5% | è‰¯å¥½ | ç›¸å¯¹è¯¯å·®å¯æ¥å— |
| 5% ~ 10% | ä¸€èˆ¬ | ç›¸å¯¹è¯¯å·®è¾ƒå¤§ |
| > 10% | è¾ƒå·® | ç›¸å¯¹è¯¯å·®å¾ˆå¤§ |

---

## ğŸ” åˆ†æå»ºè®®

### 1. ç¬¬ä¸€å±‚åˆ†æ
- **æ„ä¹‰**ï¼šåæ˜ é‡åŒ–å¯¹è¾“å…¥ç‰¹å¾çš„åˆå§‹å½±å“
- **å…³æ³¨ç‚¹**ï¼šMSEå’ŒMAE
- **æœŸæœ›**ï¼šMSE < 1e-4, Correlation > 0.999

### 2. æœ€åä¸€å±‚åˆ†æ
- **æ„ä¹‰**ï¼šåæ˜ ç´¯ç§¯è¯¯å·®å’Œæœ€ç»ˆç²¾åº¦
- **å…³æ³¨ç‚¹**ï¼šCorrelationå’ŒRelative MAE
- **æœŸæœ›**ï¼šCorrelation > 0.9999, Relative MAE < 1%

### 3. Modeå¯¹æ¯”åˆ†æ

**Mode 0 vs Mode 2-0**
- æœŸæœ›ï¼šå‡ ä¹å®Œå…¨ç›¸åŒï¼ˆéªŒè¯æ•°æ®æµæ­£ç¡®æ€§ï¼‰
- MSEå·®å¼‚ < 1e-6

**Mode 2-1 vs Mode 0**
- æœŸæœ›ï¼šç»“æœåº”è¯¥ç›¸åŒæˆ–éå¸¸æ¥è¿‘
- å¦‚æœMode 2-1æ›´å¥½ï¼šè¯´æ˜PyTorchå®ç°å¯èƒ½æ›´ç²¾ç¡®
- å¦‚æœMode 2-1æ›´å·®ï¼šPyTorchå®ç°å¯èƒ½æœ‰è¯¯

**Mode 2-2 vs Mode 2-1**
- Mode 2-2ä½¿ç”¨FP32 SSMï¼ˆåœ¨INT8 gridä¸Šï¼‰
- Mode 2-1ä½¿ç”¨PyTorch INT8
- å¯ä»¥è¯„ä¼°FP32è®¡ç®—çš„ç²¾åº¦æå‡

---

## ğŸ› ï¸ é«˜çº§ç”¨æ³•

### ä¿®æ”¹ä¿å­˜çš„å±‚

ç¼–è¾‘ `save_layer_outputs.py` ç¬¬113-114è¡Œï¼š

```python
# å½“å‰ï¼šä¿å­˜ç¬¬1å±‚å’Œæœ€åä¸€å±‚
target_layers = [0, n_layers - 1]

# ä¿®æ”¹ä¸ºï¼šä¿å­˜ç¬¬1, 12, 24å±‚
target_layers = [0, 11, n_layers - 1]
```

### å¢åŠ æ ·æœ¬æ•°é‡

```bash
python3 save_layer_outputs.py quamba-130m-w8a8 \
    --pretrained_dir pretrained_models/Quamba1-pa9999/pa-0.9999 \
    --mode fp32 \
    --calib_data_num 100 \  # é»˜è®¤10ï¼Œå¢åŠ åˆ°100
    --calib_seqlen 1024      # é»˜è®¤512ï¼Œå¢åŠ åˆ°1024
```

### è‡ªå®šä¹‰åˆ†æ

```python
import numpy as np
import matplotlib.pyplot as plt

# åŠ è½½æ•°æ®
fp32 = np.load('layer_outputs/mode_fp32_layer_0.npy')
mode21 = np.load('layer_outputs/mode_2-1_layer_0.npy')

# è®¡ç®—å·®å¼‚
diff = mode21 - fp32

# ç»˜åˆ¶å·®å¼‚åˆ†å¸ƒ
plt.hist(diff.flatten(), bins=100)
plt.xlabel('Difference')
plt.ylabel('Frequency')
plt.title('Mode 2-1 vs FP32 Difference Distribution')
plt.savefig('difference_distribution.png')
```

---

## ğŸ“ å¾…åŠäº‹é¡¹ / æ‰©å±•

- [ ] æ”¯æŒæ›´å¤šå±‚çš„å¯¹æ¯”ï¼ˆä¸åªæ˜¯ç¬¬1å’Œæœ€åä¸€å±‚ï¼‰
- [ ] æ·»åŠ å¯è§†åŒ–åŠŸèƒ½ï¼ˆè¯¯å·®åˆ†å¸ƒå›¾ã€çƒ­åŠ›å›¾ï¼‰
- [ ] æ”¯æŒbatchçº§åˆ«çš„åˆ†æï¼ˆé€æ ·æœ¬å¯¹æ¯”ï¼‰
- [ ] æ·»åŠ è‡ªåŠ¨åŒ–æŠ¥å‘Šç”Ÿæˆï¼ˆPDF/HTMLï¼‰
- [ ] é›†æˆåˆ°CI/CDæµç¨‹

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æ”¹è¿›è¿™äº›å·¥å…·ï¼å¯ä»¥è€ƒè™‘çš„æ–¹å‘ï¼š

1. æ·»åŠ æ›´å¤šè¯¯å·®æŒ‡æ ‡ï¼ˆPSNR, SSIMç­‰ï¼‰
2. æ”¯æŒå¹¶è¡Œå¤„ç†åŠ é€Ÿ
3. æ·»åŠ æ–­ç‚¹ç»­ä¼ åŠŸèƒ½
4. ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼ˆæµå¼å¤„ç†ï¼‰

---

**æœ€åæ›´æ–°**: 2025-01-10
**ä½œè€…**: Claude Code
**ç‰ˆæœ¬**: 1.0
