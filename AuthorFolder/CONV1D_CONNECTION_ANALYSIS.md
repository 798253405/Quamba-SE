# Conv1d ä¼šæ¥ Conv1d å—ï¼Ÿå®Œæ•´æ•°æ®æµåˆ†æ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜ï¼šConv1d ä¼šæ¥ Conv1d å—ï¼Ÿ

**ç­”æ¡ˆï¼šâŒ ä¸ä¼šï¼**

Conv1d **æ°¸è¿œä¸ä¼šç›´æ¥**æ¥å¦ä¸€ä¸ª Conv1dã€‚

---

## å®Œæ•´çš„æ¨¡å‹æ¶æ„

### Mamba æ¨¡å‹ç»“æ„ (Quamba2-130m ä¸ºä¾‹)

```
è¾“å…¥ (token ids)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Embedding Layer                                              â”‚
â”‚   è¾“å‡º: FP16 [B, L, D]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ ğŸ” Layer 0 (Block)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Residual + RMSNorm                                          â”‚
â”‚     â†“                                                       â”‚
â”‚ Mamba Mixer:                                                â”‚
â”‚   1ï¸âƒ£ in_proj (Linear)    [B,L,D] â†’ [B,L,2D]                â”‚
â”‚       Split â†’ x, z                                          â”‚
â”‚   2ï¸âƒ£ conv1d              x: [B,D,L] â†’ [B,D,L]              â”‚
â”‚   3ï¸âƒ£ x_proj (Linear)     [B,L,D] â†’ [B,L,dt+2*dstate]       â”‚
â”‚   4ï¸âƒ£ dt_proj (Linear)                                       â”‚
â”‚   5ï¸âƒ£ SSM (selective_scan)                                   â”‚
â”‚   6ï¸âƒ£ out_proj (Linear)   â†’ [B,L,D]                         â”‚
â”‚     â†“                                                       â”‚
â”‚ Residual Add â†’ è¾“å‡º [B,L,D]                                 â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ ğŸ” Layer 1 (Block) - å®Œå…¨ç›¸åŒçš„ç»“æ„                          â”‚
â”‚   Residual + RMSNorm â†’ in_proj â†’ conv1d â†’ x_proj â†’ ...     â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ ğŸ” Layer 2 (Block)                                          â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
    â†“
    ...
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ ğŸ” Layer 23 (Block)                                         â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Final RMSNorm                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LM Head (Linear) â†’ Logits [B, L, vocab_size]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å•ä¸ª Block å†…éƒ¨çš„è¯¦ç»†æ•°æ®æµ

```python
# Block.forward() æµç¨‹

hidden_states [B, L, D]  # æ¥è‡ªä¸Šä¸€å±‚çš„è¾“å‡º (FP16)
    â†“
residual = hidden_states + residual  # Residual connection
    â†“
hidden_states = RMSNorm(residual)  # FP16 â†’ INT8
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mixer.forward()                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1ï¸âƒ£ in_proj (Linear)                                         â”‚
â”‚    è¾“å…¥:  INT8 [B, L, D]                                     â”‚
â”‚    è¾“å‡º:  INT8 [B, L, 2*D]                                   â”‚
â”‚    Split: xz â†’ x [B, D, L], z [B, D, L]                     â”‚
â”‚                                                             â”‚
â”‚ 2ï¸âƒ£ conv1d                                                   â”‚
â”‚    è¾“å…¥:  INT8 x [B, D, L]                                   â”‚
â”‚    å†…éƒ¨:  FP32 Conv + SiLU                                  â”‚
â”‚    è¾“å‡º:  INT8 x [B, D, L]  â† ä½¿ç”¨ percentile scale!        â”‚
â”‚                                                             â”‚
â”‚ 3ï¸âƒ£ x_proj (Linear)                                          â”‚
â”‚    è¾“å…¥:  INT8 x [B, L, D]  (rearrange å)                  â”‚
â”‚    è¾“å‡º:  INT8 [B, L, dt_rank + 2*dstate]                   â”‚
â”‚    Split: dt, B, C                                          â”‚
â”‚                                                             â”‚
â”‚ 4ï¸âƒ£ dt_proj (Linear)                                         â”‚
â”‚    è¾“å…¥:  INT8 dt                                            â”‚
â”‚    è¾“å‡º:  INT8 dt                                            â”‚
â”‚                                                             â”‚
â”‚ 5ï¸âƒ£ selective_scan (SSM)                                     â”‚
â”‚    è¾“å…¥:  INT8 x, dt, B, C, z                               â”‚
â”‚    è¾“å‡º:  FP16 y [B, D, L]                                   â”‚
â”‚                                                             â”‚
â”‚ 6ï¸âƒ£ out_proj (Linear)                                        â”‚
â”‚    è¾“å…¥:  INT8 (from Had transform)                         â”‚
â”‚    è¾“å‡º:  FP16 [B, L, D]                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
hidden_states [B, L, D]  # FP16 è¾“å‡º
    â†“
ä¼ é€’ç»™ä¸‹ä¸€å±‚çš„ Block
```

---

## å…³é”®å‘ç°

### âŒ Conv1d ä¸ä¼šæ¥ Conv1d

**åŸå› **:

1. **æ¯ä¸ª Block åªæœ‰ 1 ä¸ª Conv1d**
   - åœ¨ `mixer.conv1d`
   - æ¯ä¸ª Mamba block åªå®ä¾‹åŒ–ä¸€æ¬¡ conv1d

2. **Conv1d çš„å‰é¢æ˜¯ Linear (in_proj)**
   ```
   in_proj (Linear) â†’ conv1d
   ```

3. **Conv1d çš„åé¢æ˜¯ Linear (x_proj)**
   ```
   conv1d â†’ x_proj (Linear)
   ```

4. **ä¸åŒ Block ä¹‹é—´æœ‰ Residual + Norm**
   ```
   Layer 0:
     conv1d â†’ ... â†’ out_proj (FP16 è¾“å‡º)
         â†“
   Residual Add + RMSNorm (INT8 è¾“å‡º)
         â†“
   Layer 1:
     in_proj (Linear, æ¥æ”¶ INT8) â†’ conv1d
   ```

---

## ä»£ç éªŒè¯

### Block å®šä¹‰ (3rdparty/mamba/mamba_ssm/modules/block.py:10-30)

```python
class Block(nn.Module):
    def __init__(self, dim, mixer_cls, mlp_cls, norm_cls=nn.LayerNorm, ...):
        super().__init__()
        self.norm = norm_cls(dim)      # RMSNorm
        self.mixer = mixer_cls(dim)     # MambaMixer (åŒ…å« conv1d)
        # ... mlp åœ¨ Mamba ä¸­é€šå¸¸æ˜¯ None
```

### Mixer å®šä¹‰ (qMambaLayer.py:895-941)

```python
def forward(self, hidden_states, inference_params=None):
    # 1. in_proj
    xz = self.in_proj.to_seqlen_last(hidden_states) #(B, D, L)
    x, z = xz.chunk(2, dim=1)

    # 2. conv1d (åªæœ‰è¿™ä¸€ä¸ª!)
    x = self.conv1d.forward(x)

    # 3. x_proj
    x_reshape = rearrange(x, "b d l -> b l d").contiguous()
    x_dbl = self.x_proj(x_reshape)
    dt, B, C = torch.split(x_dbl, ...)

    # 4. dt_proj
    dt = self.dt_proj.to_seqlen_last(dt.contiguous())

    # 5. SSM
    y = self.selective_scan.forward(x, dt, B, C, z=z, ...)

    # 6. out_proj
    y = self.had(y)
    out = self.out_proj(y)
    return out
```

### æ¨¡å‹å±‚å®šä¹‰ (quamba_mixer_seq.py:312-330)

```python
self.layers = nn.ModuleList(
    [
        create_quantized_block(...)  # æ¯ä¸ª Block ç‹¬ç«‹
        for i in range(n_layer)      # 24 ä¸ªç‹¬ç«‹çš„ Block
    ]
)
```

---

## æ•°æ®æµæ€»ç»“

### å®Œæ•´è·¯å¾„ (Layer i â†’ Layer i+1)

```
Layer i:
  conv1d è¾“å‡º [B,D,L] INT8
      â†“
  x_proj (Linear) [B,L,D] INT8
      â†“
  SSM â†’ FP16 [B,D,L]
      â†“
  out_proj â†’ FP16 [B,L,D]
      â†“
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Block è¾¹ç•Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â†“
  Residual Add (FP16 + FP16)
      â†“
  RMSNorm (FP16 â†’ INT8) [B,L,D]
      â†“
Layer i+1:
  in_proj (Linear, INT8 â†’ INT8) [B,L,2D]
      â†“
  conv1d [B,D,L] INT8
```

### å…³é”®ç‚¹

| è¿æ¥ | å‰ä¸€ä¸ªå±‚ | åä¸€ä¸ªå±‚ | ä¸­é—´éš”äº†ä»€ä¹ˆ |
|-----|---------|---------|------------|
| **åŒä¸€ Block å†…** | conv1d | x_proj | ç›´æ¥è¿æ¥ (INT8) |
| **ä¸åŒ Block é—´** | Layer i çš„ out_proj | Layer i+1 çš„ in_proj | Residual + RMSNorm |

---

## ğŸ”¥ ä¸ºä»€ä¹ˆè¿™ä¸ªé—®é¢˜å¾ˆå…³é”®ï¼Ÿ

### å¯¹ Percentile Scale çš„å½±å“

1. **Conv1d çš„ output_scale åªç”¨ä¸€æ¬¡**
   ```
   conv1d è¾“å‡º (INT8, ç”¨ percentile scale) â†’ x_proj è¾“å…¥
   ```
   - Percentile scale åœ¨ conv1d è¾“å‡ºæ—¶é‡åŒ–
   - ä¸‹ä¸€ä¸ªæ¨¡å—æ˜¯ x_proj (Linear)ï¼Œä¸æ˜¯å¦ä¸€ä¸ª conv1d

2. **ä¸åŒå±‚çš„ Conv1d æ˜¯ç‹¬ç«‹çš„**
   ```
   Layer 0 çš„ conv1d: æœ‰è‡ªå·±çš„ percentile scale
   Layer 1 çš„ conv1d: æœ‰è‡ªå·±çš„ percentile scale
   ...
   Layer 23 çš„ conv1d: æœ‰è‡ªå·±çš„ percentile scale
   ```
   - 24 ä¸ªç‹¬ç«‹çš„ conv1d
   - 24 ä¸ªç‹¬ç«‹çš„ percentile scale
   - å®ƒä»¬ä¹‹é—´**ä¸ç›´æ¥è¿æ¥**

3. **å¦‚æœä¿®æ”¹ Conv1d çš„ output_scale**
   ```python
   # åªå½±å“å½“å‰å±‚çš„ conv1d â†’ x_proj è¿æ¥
   model.backbone.layers[0].mixer.conv1d.output_scale *= 1.5

   # ä¸ä¼šå½±å“:
   # - Layer 1 çš„ conv1d
   # - Layer 0 çš„å…¶ä»– Linear å±‚
   ```

---

## æ€»ç»“

### âœ… ç¡®è®¤çš„äº‹å®

1. **Conv1d ä¸ä¼šæ¥ Conv1d** (åŒä¸€ Block å†…åªæœ‰ 1 ä¸ª conv1d)
2. **Conv1d çš„å‰é¢æ˜¯ Linear (in_proj)**
3. **Conv1d çš„åé¢æ˜¯ Linear (x_proj)**
4. **ä¸åŒ Block çš„ Conv1d ä¹‹é—´æœ‰ Residual + Norm + Linear**

### ğŸ¯ å¯¹ Percentile Scale çš„å½±å“

- âœ… Percentile scale åªå½±å“ **conv1d â†’ x_proj** çš„è¿æ¥
- âœ… æ¯å±‚çš„ conv1d æœ‰ç‹¬ç«‹çš„ percentile scale
- âœ… ä¿®æ”¹æŸä¸€å±‚çš„ conv1d scale ä¸ä¼šå½±å“å…¶ä»–å±‚

### ğŸ“ å®Œæ•´æ•°æ®æµ

```
Token IDs
    â†“
Embedding (FP16)
    â†“
[Layer 0]
    Residual+Norm â†’ in_proj â†’ conv1d â†’ x_proj â†’ SSM â†’ out_proj
                     (Linear)  (å”¯ä¸€)  (Linear)
    â†“ (FP16)
Residual+Norm (INT8)
    â†“
[Layer 1]
    in_proj â†’ conv1d â†’ x_proj â†’ SSM â†’ out_proj
    (Linear)  (å”¯ä¸€)  (Linear)
    â†“
...
    â†“
[Layer 23]
    in_proj â†’ conv1d â†’ x_proj â†’ SSM â†’ out_proj
    â†“
Final Norm â†’ LM Head
```

**å…³é”®**: Conv1d æ°¸è¿œè¢« Linear å±‚åŒ…å›´ï¼Œæ°¸è¿œä¸ä¼šç›´æ¥æ¥å¦ä¸€ä¸ª Conv1dï¼
